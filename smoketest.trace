+ set -euo pipefail
+ BASE_URL=http://localhost:3000
+ API=http://localhost:3000/api/v1
+ require_bin curl
+ command -v curl
+ require_env ADMIN_EMAIL
+ local n=ADMIN_EMAIL
+ [[ -n alex.admin@example.test ]]
+ require_env ADMIN_PASSWORD
+ local n=ADMIN_PASSWORD
+ [[ -n Admin#1234 ]]
++ date +%s
+ TS=1755535372
++ printf %04d 3443
+ RND=3443
+ NURSE_EMAIL=nurse_1755535372_3443@example.com
+ NURSE_PASS=Nurse#3443Aa
+ CARE_EMAIL=care_1755535372_3443@example.com
+ CARE_PASS=Care#3443Aa
+ PAT_EMAIL=patient_1755535372_3443@example.com
+ PAT_PASS=Patient#3443Aa
++ mktemp -d
+ TMP_DIR=/tmp/tmp.G4mNsOktpX
+ trap 'rm -rf "$TMP_DIR"' EXIT
+ AUTH_OPTS=()
+ echo '== Admin login =='
== Admin login ==
++ get_token alex.admin@example.test Admin#1234
++ local e=alex.admin@example.test
++ local p=Admin#1234
++ local O=/tmp/tmp.G4mNsOktpX/login.json
++ clear_auth
++ AUTH_OPTS=()
++ req_quiet POST /users/login '{"email":"alex.admin@example.test","password":"Admin#1234"}' 200 /tmp/tmp.G4mNsOktpX/login.json
++ req POST /users/login '{"email":"alex.admin@example.test","password":"Admin#1234"}' 200 /tmp/tmp.G4mNsOktpX/login.json
++ local method=POST
++ shift
++ local path=/users/login
++ shift
++ local 'data={"email":"alex.admin@example.test","password":"Admin#1234"}'
++ shift
++ local expects=200
++ shift
++ local out=/tmp/tmp.G4mNsOktpX/login.json
++ IFS=,
++ read -r -a expect_arr
++ local url=http://localhost:3000/api/v1/users/login
++ local RES_FILE=/tmp/tmp.G4mNsOktpX/res.json
++ local code
++ [[ -n {"email":"alex.admin@example.test","password":"Admin#1234"} ]]
+++ _curl_capture /tmp/tmp.G4mNsOktpX/res.json -X POST http://localhost:3000/api/v1/users/login -H 'Content-Type: application/json' --data '{"email":"alex.admin@example.test","password":"Admin#1234"}'
+++ local outfile=/tmp/tmp.G4mNsOktpX/res.json
+++ shift
+++ :
+++ set +e
+++ local http_code
++++ curl -sS -o /tmp/tmp.G4mNsOktpX/res.json -w '%{http_code}' -X POST http://localhost:3000/api/v1/users/login -H 'Content-Type: application/json' --data '{"email":"alex.admin@example.test","password":"Admin#1234"}'
+++ http_code=200
+++ local curl_rc=0
+++ set -e
+++ [[ 0 -ne 0 ]]
+++ echo 200
++ code=200
++ [[ 200 == CURL_ERR:* ]]
++ echo 'HTTP 200 — POST /users/login'
++ local ok=no
++ for e in "${expect_arr[@]}"
++ [[ 200 == \2\0\0 ]]
++ ok=yes
++ break
++ [[ yes != \y\e\s ]]
++ [[ -n /tmp/tmp.G4mNsOktpX/login.json ]]
++ cp /tmp/tmp.G4mNsOktpX/res.json /tmp/tmp.G4mNsOktpX/login.json
++ extract_token /tmp/tmp.G4mNsOktpX/login.json
++ grep -oE '("token"|"accessToken"|"jwt")\s*:\s*"[^"]+"' /tmp/tmp.G4mNsOktpX/login.json
++ head -n1
++ sed -E 's/.*:\s*"([^"]+)".*/\1/'
+ ADMIN_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4
+ set_auth eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4
+ AUTH_OPTS=(-H "Authorization: Bearer $1")
++ printf %s alex.admin@example.test
++ sed -E s/@/%40/g
+ req GET '/admin/users?query=alex.admin%40example.test' '' 200 /tmp/tmp.G4mNsOktpX/admin_user.json
+ local method=GET
+ shift
+ local 'path=/admin/users?query=alex.admin%40example.test'
+ shift
+ local data=
+ shift
+ local expects=200
+ shift
+ local out=/tmp/tmp.G4mNsOktpX/admin_user.json
+ IFS=,
+ read -r -a expect_arr
+ local 'url=http://localhost:3000/api/v1/admin/users?query=alex.admin%40example.test'
+ local RES_FILE=/tmp/tmp.G4mNsOktpX/res.json
+ local code
+ [[ -n '' ]]
++ _curl_capture /tmp/tmp.G4mNsOktpX/res.json -X GET 'http://localhost:3000/api/v1/admin/users?query=alex.admin%40example.test' -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4'
++ local outfile=/tmp/tmp.G4mNsOktpX/res.json
++ shift
++ :
++ set +e
++ local http_code
+++ curl -sS -o /tmp/tmp.G4mNsOktpX/res.json -w '%{http_code}' -X GET 'http://localhost:3000/api/v1/admin/users?query=alex.admin%40example.test' -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4'
++ http_code=200
++ local curl_rc=0
++ set -e
++ [[ 0 -ne 0 ]]
++ echo 200
+ code=200
+ [[ 200 == CURL_ERR:* ]]
+ echo 'HTTP 200 — GET /admin/users?query=alex.admin%40example.test'
HTTP 200 — GET /admin/users?query=alex.admin%40example.test
+ local ok=no
+ for e in "${expect_arr[@]}"
+ [[ 200 == \2\0\0 ]]
+ ok=yes
+ break
+ [[ yes != \y\e\s ]]
+ [[ -n /tmp/tmp.G4mNsOktpX/admin_user.json ]]
+ cp /tmp/tmp.G4mNsOktpX/res.json /tmp/tmp.G4mNsOktpX/admin_user.json
++ extract_first_user_id /tmp/tmp.G4mNsOktpX/admin_user.json
++ grep -oE '"_id"\s*:\s*"[^"]+"' /tmp/tmp.G4mNsOktpX/admin_user.json
++ head -n1
++ sed -E 's/.*:\s*"([^"]+)".*/\1/'
+ ADMIN_ID=68a34eec803259b87273b540
+ echo 'ADMIN_ID: 68a34eec803259b87273b540'
ADMIN_ID: 68a34eec803259b87273b540
+ echo '== Register Nurse =='
== Register Nurse ==
+ clear_auth
+ AUTH_OPTS=()
+ req POST /users/register '{"fullName":"Nurse 1755535372","email":"nurse_1755535372_3443@example.com","password":"Nurse#3443Aa","confirmPassword":"Nurse#3443Aa"}' 200,201 /tmp/tmp.G4mNsOktpX/nurse_reg.json
+ local method=POST
+ shift
+ local path=/users/register
+ shift
+ local 'data={"fullName":"Nurse 1755535372","email":"nurse_1755535372_3443@example.com","password":"Nurse#3443Aa","confirmPassword":"Nurse#3443Aa"}'
+ shift
+ local expects=200,201
+ shift
+ local out=/tmp/tmp.G4mNsOktpX/nurse_reg.json
+ IFS=,
+ read -r -a expect_arr
+ local url=http://localhost:3000/api/v1/users/register
+ local RES_FILE=/tmp/tmp.G4mNsOktpX/res.json
+ local code
+ [[ -n {"fullName":"Nurse 1755535372","email":"nurse_1755535372_3443@example.com","password":"Nurse#3443Aa","confirmPassword":"Nurse#3443Aa"} ]]
++ _curl_capture /tmp/tmp.G4mNsOktpX/res.json -X POST http://localhost:3000/api/v1/users/register -H 'Content-Type: application/json' --data '{"fullName":"Nurse 1755535372","email":"nurse_1755535372_3443@example.com","password":"Nurse#3443Aa","confirmPassword":"Nurse#3443Aa"}'
++ local outfile=/tmp/tmp.G4mNsOktpX/res.json
++ shift
++ :
++ set +e
++ local http_code
+++ curl -sS -o /tmp/tmp.G4mNsOktpX/res.json -w '%{http_code}' -X POST http://localhost:3000/api/v1/users/register -H 'Content-Type: application/json' --data '{"fullName":"Nurse 1755535372","email":"nurse_1755535372_3443@example.com","password":"Nurse#3443Aa","confirmPassword":"Nurse#3443Aa"}'
++ http_code=201
++ local curl_rc=0
++ set -e
++ [[ 0 -ne 0 ]]
++ echo 201
+ code=201
+ [[ 201 == CURL_ERR:* ]]
+ echo 'HTTP 201 — POST /users/register'
HTTP 201 — POST /users/register
+ local ok=no
+ for e in "${expect_arr[@]}"
+ [[ 201 == \2\0\0 ]]
+ for e in "${expect_arr[@]}"
+ [[ 201 == \2\0\1 ]]
+ ok=yes
+ break
+ [[ yes != \y\e\s ]]
+ [[ -n /tmp/tmp.G4mNsOktpX/nurse_reg.json ]]
+ cp /tmp/tmp.G4mNsOktpX/res.json /tmp/tmp.G4mNsOktpX/nurse_reg.json
+ set_auth eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4
+ AUTH_OPTS=(-H "Authorization: Bearer $1")
++ printf %s nurse_1755535372_3443@example.com
++ sed -E s/@/%40/g
+ req GET '/admin/users?query=nurse_1755535372_3443%40example.com' '' 200 /tmp/tmp.G4mNsOktpX/nurse_lookup.json
+ local method=GET
+ shift
+ local 'path=/admin/users?query=nurse_1755535372_3443%40example.com'
+ shift
+ local data=
+ shift
+ local expects=200
+ shift
+ local out=/tmp/tmp.G4mNsOktpX/nurse_lookup.json
+ IFS=,
+ read -r -a expect_arr
+ local 'url=http://localhost:3000/api/v1/admin/users?query=nurse_1755535372_3443%40example.com'
+ local RES_FILE=/tmp/tmp.G4mNsOktpX/res.json
+ local code
+ [[ -n '' ]]
++ _curl_capture /tmp/tmp.G4mNsOktpX/res.json -X GET 'http://localhost:3000/api/v1/admin/users?query=nurse_1755535372_3443%40example.com' -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4'
++ local outfile=/tmp/tmp.G4mNsOktpX/res.json
++ shift
++ :
++ set +e
++ local http_code
+++ curl -sS -o /tmp/tmp.G4mNsOktpX/res.json -w '%{http_code}' -X GET 'http://localhost:3000/api/v1/admin/users?query=nurse_1755535372_3443%40example.com' -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4'
++ http_code=200
++ local curl_rc=0
++ set -e
++ [[ 0 -ne 0 ]]
++ echo 200
+ code=200
+ [[ 200 == CURL_ERR:* ]]
+ echo 'HTTP 200 — GET /admin/users?query=nurse_1755535372_3443%40example.com'
HTTP 200 — GET /admin/users?query=nurse_1755535372_3443%40example.com
+ local ok=no
+ for e in "${expect_arr[@]}"
+ [[ 200 == \2\0\0 ]]
+ ok=yes
+ break
+ [[ yes != \y\e\s ]]
+ [[ -n /tmp/tmp.G4mNsOktpX/nurse_lookup.json ]]
+ cp /tmp/tmp.G4mNsOktpX/res.json /tmp/tmp.G4mNsOktpX/nurse_lookup.json
++ extract_first_user_id /tmp/tmp.G4mNsOktpX/nurse_lookup.json
++ grep -oE '"_id"\s*:\s*"[^"]+"' /tmp/tmp.G4mNsOktpX/nurse_lookup.json
++ head -n1
++ sed -E 's/.*:\s*"([^"]+)".*/\1/'
+ NURSE_ID=68a3580d803259b87273b5d8
+ echo 'NURSE_ID: 68a3580d803259b87273b5d8'
NURSE_ID: 68a3580d803259b87273b5d8
+ echo '== Register Caretaker =='
== Register Caretaker ==
+ clear_auth
+ AUTH_OPTS=()
+ req POST /users/register '{"fullName":"Caretaker 1755535372","email":"care_1755535372_3443@example.com","password":"Care#3443Aa","confirmPassword":"Care#3443Aa"}' 200,201 /tmp/tmp.G4mNsOktpX/care_reg.json
+ local method=POST
+ shift
+ local path=/users/register
+ shift
+ local 'data={"fullName":"Caretaker 1755535372","email":"care_1755535372_3443@example.com","password":"Care#3443Aa","confirmPassword":"Care#3443Aa"}'
+ shift
+ local expects=200,201
+ shift
+ local out=/tmp/tmp.G4mNsOktpX/care_reg.json
+ IFS=,
+ read -r -a expect_arr
+ local url=http://localhost:3000/api/v1/users/register
+ local RES_FILE=/tmp/tmp.G4mNsOktpX/res.json
+ local code
+ [[ -n {"fullName":"Caretaker 1755535372","email":"care_1755535372_3443@example.com","password":"Care#3443Aa","confirmPassword":"Care#3443Aa"} ]]
++ _curl_capture /tmp/tmp.G4mNsOktpX/res.json -X POST http://localhost:3000/api/v1/users/register -H 'Content-Type: application/json' --data '{"fullName":"Caretaker 1755535372","email":"care_1755535372_3443@example.com","password":"Care#3443Aa","confirmPassword":"Care#3443Aa"}'
++ local outfile=/tmp/tmp.G4mNsOktpX/res.json
++ shift
++ :
++ set +e
++ local http_code
+++ curl -sS -o /tmp/tmp.G4mNsOktpX/res.json -w '%{http_code}' -X POST http://localhost:3000/api/v1/users/register -H 'Content-Type: application/json' --data '{"fullName":"Caretaker 1755535372","email":"care_1755535372_3443@example.com","password":"Care#3443Aa","confirmPassword":"Care#3443Aa"}'
++ http_code=201
++ local curl_rc=0
++ set -e
++ [[ 0 -ne 0 ]]
++ echo 201
+ code=201
+ [[ 201 == CURL_ERR:* ]]
+ echo 'HTTP 201 — POST /users/register'
HTTP 201 — POST /users/register
+ local ok=no
+ for e in "${expect_arr[@]}"
+ [[ 201 == \2\0\0 ]]
+ for e in "${expect_arr[@]}"
+ [[ 201 == \2\0\1 ]]
+ ok=yes
+ break
+ [[ yes != \y\e\s ]]
+ [[ -n /tmp/tmp.G4mNsOktpX/care_reg.json ]]
+ cp /tmp/tmp.G4mNsOktpX/res.json /tmp/tmp.G4mNsOktpX/care_reg.json
+ set_auth eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4
+ AUTH_OPTS=(-H "Authorization: Bearer $1")
++ printf %s care_1755535372_3443@example.com
++ sed -E s/@/%40/g
+ req GET '/admin/users?query=care_1755535372_3443%40example.com' '' 200 /tmp/tmp.G4mNsOktpX/care_lookup.json
+ local method=GET
+ shift
+ local 'path=/admin/users?query=care_1755535372_3443%40example.com'
+ shift
+ local data=
+ shift
+ local expects=200
+ shift
+ local out=/tmp/tmp.G4mNsOktpX/care_lookup.json
+ IFS=,
+ read -r -a expect_arr
+ local 'url=http://localhost:3000/api/v1/admin/users?query=care_1755535372_3443%40example.com'
+ local RES_FILE=/tmp/tmp.G4mNsOktpX/res.json
+ local code
+ [[ -n '' ]]
++ _curl_capture /tmp/tmp.G4mNsOktpX/res.json -X GET 'http://localhost:3000/api/v1/admin/users?query=care_1755535372_3443%40example.com' -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4'
++ local outfile=/tmp/tmp.G4mNsOktpX/res.json
++ shift
++ :
++ set +e
++ local http_code
+++ curl -sS -o /tmp/tmp.G4mNsOktpX/res.json -w '%{http_code}' -X GET 'http://localhost:3000/api/v1/admin/users?query=care_1755535372_3443%40example.com' -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4'
++ http_code=200
++ local curl_rc=0
++ set -e
++ [[ 0 -ne 0 ]]
++ echo 200
+ code=200
+ [[ 200 == CURL_ERR:* ]]
+ echo 'HTTP 200 — GET /admin/users?query=care_1755535372_3443%40example.com'
HTTP 200 — GET /admin/users?query=care_1755535372_3443%40example.com
+ local ok=no
+ for e in "${expect_arr[@]}"
+ [[ 200 == \2\0\0 ]]
+ ok=yes
+ break
+ [[ yes != \y\e\s ]]
+ [[ -n /tmp/tmp.G4mNsOktpX/care_lookup.json ]]
+ cp /tmp/tmp.G4mNsOktpX/res.json /tmp/tmp.G4mNsOktpX/care_lookup.json
++ extract_first_user_id /tmp/tmp.G4mNsOktpX/care_lookup.json
++ grep -oE '"_id"\s*:\s*"[^"]+"' /tmp/tmp.G4mNsOktpX/care_lookup.json
++ head -n1
++ sed -E 's/.*:\s*"([^"]+)".*/\1/'
+ CARE_ID=68a3580d803259b87273b5dd
+ echo 'CARETAKER_ID: 68a3580d803259b87273b5dd'
CARETAKER_ID: 68a3580d803259b87273b5dd
+ echo '== Register Patient User =='
== Register Patient User ==
+ clear_auth
+ AUTH_OPTS=()
+ req POST /users/register '{"fullName":"Patient 1755535372","email":"patient_1755535372_3443@example.com","password":"Patient#3443Aa","confirmPassword":"Patient#3443Aa"}' 200,201 /tmp/tmp.G4mNsOktpX/pat_reg.json
+ local method=POST
+ shift
+ local path=/users/register
+ shift
+ local 'data={"fullName":"Patient 1755535372","email":"patient_1755535372_3443@example.com","password":"Patient#3443Aa","confirmPassword":"Patient#3443Aa"}'
+ shift
+ local expects=200,201
+ shift
+ local out=/tmp/tmp.G4mNsOktpX/pat_reg.json
+ IFS=,
+ read -r -a expect_arr
+ local url=http://localhost:3000/api/v1/users/register
+ local RES_FILE=/tmp/tmp.G4mNsOktpX/res.json
+ local code
+ [[ -n {"fullName":"Patient 1755535372","email":"patient_1755535372_3443@example.com","password":"Patient#3443Aa","confirmPassword":"Patient#3443Aa"} ]]
++ _curl_capture /tmp/tmp.G4mNsOktpX/res.json -X POST http://localhost:3000/api/v1/users/register -H 'Content-Type: application/json' --data '{"fullName":"Patient 1755535372","email":"patient_1755535372_3443@example.com","password":"Patient#3443Aa","confirmPassword":"Patient#3443Aa"}'
++ local outfile=/tmp/tmp.G4mNsOktpX/res.json
++ shift
++ :
++ set +e
++ local http_code
+++ curl -sS -o /tmp/tmp.G4mNsOktpX/res.json -w '%{http_code}' -X POST http://localhost:3000/api/v1/users/register -H 'Content-Type: application/json' --data '{"fullName":"Patient 1755535372","email":"patient_1755535372_3443@example.com","password":"Patient#3443Aa","confirmPassword":"Patient#3443Aa"}'
++ http_code=201
++ local curl_rc=0
++ set -e
++ [[ 0 -ne 0 ]]
++ echo 201
+ code=201
+ [[ 201 == CURL_ERR:* ]]
+ echo 'HTTP 201 — POST /users/register'
HTTP 201 — POST /users/register
+ local ok=no
+ for e in "${expect_arr[@]}"
+ [[ 201 == \2\0\0 ]]
+ for e in "${expect_arr[@]}"
+ [[ 201 == \2\0\1 ]]
+ ok=yes
+ break
+ [[ yes != \y\e\s ]]
+ [[ -n /tmp/tmp.G4mNsOktpX/pat_reg.json ]]
+ cp /tmp/tmp.G4mNsOktpX/res.json /tmp/tmp.G4mNsOktpX/pat_reg.json
+ set_auth eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4
+ AUTH_OPTS=(-H "Authorization: Bearer $1")
++ printf %s patient_1755535372_3443@example.com
++ sed -E s/@/%40/g
+ req GET '/admin/users?query=patient_1755535372_3443%40example.com' '' 200 /tmp/tmp.G4mNsOktpX/pat_lookup.json
+ local method=GET
+ shift
+ local 'path=/admin/users?query=patient_1755535372_3443%40example.com'
+ shift
+ local data=
+ shift
+ local expects=200
+ shift
+ local out=/tmp/tmp.G4mNsOktpX/pat_lookup.json
+ IFS=,
+ read -r -a expect_arr
+ local 'url=http://localhost:3000/api/v1/admin/users?query=patient_1755535372_3443%40example.com'
+ local RES_FILE=/tmp/tmp.G4mNsOktpX/res.json
+ local code
+ [[ -n '' ]]
++ _curl_capture /tmp/tmp.G4mNsOktpX/res.json -X GET 'http://localhost:3000/api/v1/admin/users?query=patient_1755535372_3443%40example.com' -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4'
++ local outfile=/tmp/tmp.G4mNsOktpX/res.json
++ shift
++ :
++ set +e
++ local http_code
+++ curl -sS -o /tmp/tmp.G4mNsOktpX/res.json -w '%{http_code}' -X GET 'http://localhost:3000/api/v1/admin/users?query=patient_1755535372_3443%40example.com' -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4'
++ http_code=200
++ local curl_rc=0
++ set -e
++ [[ 0 -ne 0 ]]
++ echo 200
+ code=200
+ [[ 200 == CURL_ERR:* ]]
+ echo 'HTTP 200 — GET /admin/users?query=patient_1755535372_3443%40example.com'
HTTP 200 — GET /admin/users?query=patient_1755535372_3443%40example.com
+ local ok=no
+ for e in "${expect_arr[@]}"
+ [[ 200 == \2\0\0 ]]
+ ok=yes
+ break
+ [[ yes != \y\e\s ]]
+ [[ -n /tmp/tmp.G4mNsOktpX/pat_lookup.json ]]
+ cp /tmp/tmp.G4mNsOktpX/res.json /tmp/tmp.G4mNsOktpX/pat_lookup.json
++ extract_first_user_id /tmp/tmp.G4mNsOktpX/pat_lookup.json
++ grep -oE '"_id"\s*:\s*"[^"]+"' /tmp/tmp.G4mNsOktpX/pat_lookup.json
++ head -n1
++ sed -E 's/.*:\s*"([^"]+)".*/\1/'
+ PAT_USER_ID=68a3580d803259b87273b5e2
+ echo 'PAT_USER_ID: 68a3580d803259b87273b5e2'
PAT_USER_ID: 68a3580d803259b87273b5e2
+ echo '== Admin approves & sets roles =='
== Admin approves & sets roles ==
+ req PUT /admin/users/68a3580d803259b87273b5d8/approve '' 200,204,409
+ local method=PUT
+ shift
+ local path=/admin/users/68a3580d803259b87273b5d8/approve
+ shift
+ local data=
+ shift
+ local expects=200,204,409
+ shift
+ local out=
+ IFS=,
+ read -r -a expect_arr
+ local url=http://localhost:3000/api/v1/admin/users/68a3580d803259b87273b5d8/approve
+ local RES_FILE=/tmp/tmp.G4mNsOktpX/res.json
+ local code
+ [[ -n '' ]]
++ _curl_capture /tmp/tmp.G4mNsOktpX/res.json -X PUT http://localhost:3000/api/v1/admin/users/68a3580d803259b87273b5d8/approve -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4'
++ local outfile=/tmp/tmp.G4mNsOktpX/res.json
++ shift
++ :
++ set +e
++ local http_code
+++ curl -sS -o /tmp/tmp.G4mNsOktpX/res.json -w '%{http_code}' -X PUT http://localhost:3000/api/v1/admin/users/68a3580d803259b87273b5d8/approve -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2OGEzNGVlYzgwMzI1OWI4NzI3M2I1NDAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTU1MzUzNzMsImV4cCI6MTc1NjE0MDE3M30.sSTk5z7ZMREJcC8vpU0ettK8gMic884xk6akXMvqSI4'
++ http_code=200
++ local curl_rc=0
++ set -e
++ [[ 0 -ne 0 ]]
++ echo 200
+ code=200
+ [[ 200 == CURL_ERR:* ]]
+ echo 'HTTP 200 — PUT /admin/users/68a3580d803259b87273b5d8/approve'
HTTP 200 — PUT /admin/users/68a3580d803259b87273b5d8/approve
+ local ok=no
+ for e in "${expect_arr[@]}"
+ [[ 200 == \2\0\0 ]]
+ ok=yes
+ break
+ [[ yes != \y\e\s ]]
+ [[ -n '' ]]
+ rm -rf /tmp/tmp.G4mNsOktpX
